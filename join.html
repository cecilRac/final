<!DOCTYPE html>
<html lang="en">

<head>

  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    var OneSignal = window.OneSignal || [];
    OneSignal.push(["init", {
      appId: "57006a7b-494b-426e-8534-e3374052cdb7",
      autoRegister: false,
      notifyButton: {
        enable: false /* Set to false to hide */
      }
    }]);
  </script>
  
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mo'Go</title>

	<!-- CSS -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,100,300,500">
	<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="assets/css/form-elements.css">
	<link rel="stylesheet" href="assets/css/style.css">



      <!-- Script yo! -->
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
     <script src="https://maps.google.com/maps/api/js?sensor=false"></script> 
     <script src="https://checkout.stripe.com/checkout.js"></script> 

	

<script>
var marker;
var gloLat;
var gloLng;
var infoWindow;
if (navigator.geolocation) {
    var timeoutVal = 10 * 1000 * 1000;


    navigator.geolocation.getCurrentPosition(
        displayPosition, 
        displayError,
        { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 }


        );
}
else {
   
    alert("Geolocation is not supported by this browser");
}

function displayPosition(position) {            
   // var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

    gloLat = position.coords.latitude;
    gloLng = position.coords.longitude;

               

        }


         function displayError(error) {
            var errors = { 
                1: 'Phone/Browser permission denied',
                2: 'Position unavailable',
                3: 'Request timeout'
 
            };

            $("#map").empty();
            $("#map").append(

         "<div class='page-alert alert alert-warning' >"+
          "<button class='close' data-dismiss='alert'> x </button>"+
          'Kindly allow GPS access on your Device.'+

         "</div>"      );

   
            alert("Error: " + errors[error.code]);

            
        }



    
         
       

        </script>  


	<link rel="shortcut icon" href="assets/ico/favicon.png">

	

</head>

<body>

<!-- Top content -->
<div class="top-content">

	<div class="inner-bg">
		<div class="container">

			<div class="row">
				<div class="col-sm-8 col-sm-offset-2 text">
					<h1><strong>Mo'Go! </strong> Accra is yours</h1>
					<div class="description">
						<p>
							
						</p>
					</div>
				</div>
			</div>

			<div class="row">

				<div class=" col-md-6 col-sm-8 col-xs-12 center-block" style="float: none !important;">

					<div class="form-box">

						

						<form id="driverForm" role="form" action="" method="post" class="registration-form">

							<!--First Section-->
							<!-- Headers of shared table -->
							<div class="step" >
								<div class="form-bottom">
									
			
							<table class="table table-striped">
										
								<thead>
                        			<tr>
                         			 <th>Trip(s) info</th>
                         
                         			  <th></th>
                  
                        			</tr>

                      			</thead>

                     
                        	<tbody id="loading" name="loading"> </tbody>
                
									

							</table>	

              <div id="sorryMessage"></div>
										
						<!--	<a href="trip.html">			
							   <div class="btn-group btn-group-justified form-bottom">	
								
									<span id=""  class="btn btn-default "> 
			                      		<span class="fa-icon-circle">
			                            <i class="fa fa-arrow-circle-left "></i>
			                      		</span> 

                        				<big> Back  </big>

                    				</span>	

                    		</div>	
                    		</a> 

              -->

								</div>


			
							</div>
							<!--End first section-->



						</form>

					</div>


				</div>
			</div>

		</div>
	</div>

</div>

<!-- Footer -->
<footer>
	<div class="container">
		<div class="row">

			<div class="col-sm-8 col-sm-offset-2">
				<div class="footer-border"></div>
				<p>&copy; Copyright 2016 Makewego Company Limited - Mogo<i class="fa fa-smile-o"></i></p>
			</div>

		</div>
	</div>
</footer>

<!-- Javascript -->
<script src="assets/js/jquery-1.11.1.min.js"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/bootstrap/js/bootstrap.min.js"></script>
<script src="assets/js/jquery.backstretch.min.js"></script>
<script src="assets/js/jquery.wizard.js"></script>
<script src="assets/js/custom_script.js"></script>

<!--[if lt IE 10]>
<script type="application/javascript">
	$(document).ready(function(){

		$('input[type="text"], input[type="password"], textarea').each(function() {
			$(this).val( $(this).attr('placeholder') );
		});

	});
</script>
<![endif]-->

 <script type="text/javascript">

 $(document).ready(function(){
 	console.log('ready');

 	loadData();

  var sharedTripData;

  var isDriver =0;



  var lati;
  var longi; 
 	var user;
 	var token;//= 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJfaWQiOiI1NzA5MzQ4NjIwZmZjNDAzMDA5MDY4NGEiLCJpYXQiOjE0Nzg4MDUxNTQ2ODIsImV4cCI6MTk3OTk3MTc0NzExNDA1NDcwMH0.Tq5DkTfysljHIMepEp6UPC_PPTTCc9Mo5s0ngwgiccs';
 	
 	    function loadData() {

 	    	console.log('Loading Data.');

       var account = localStorage.getItem('_account');
       if (!account) return false;
     //  localStorage.removeItem('_account');
       //decodes a string data encoded using base-64
       account = atob(account);
       //parses to Object the JSON string
       account = JSON.parse(account);
       //do what you need with the Object
       user = account.User;
       token= account.token;
        lati = account.lat;
        longi = account.lng;
        console.log("lati =",lati);
        console.log("longi =",longi);

        if( user.licensePin==""){
            isDriver =1;

            console.log("user is a driver");
        }

       sharedRide();
      
 		 }

      //  console.log("in landmarks popping");

        //var searchTxt = $("input[name='destination']").val();

  function sharedRide(){
       // var token = token;

       var ridesAvailable = 0;
       console.log ("In sharedRide");
       

        $.get("https://makewegohq.herokuapp.com/api/trips", {access_token:token} , function(data){

            sharedTripData=data;
               //console.log ("these are the trips",data);
               // outputDiv.html('');
                var town;
                   var places = data;

                for (var index in places){


                    var town = places[index];

                    //console.log("locs = ", town.departure.place.loc);

                    if (town.trip_type!="Dropping" && town.departure.place !==null){

                       // if(){

                      var myDate = new Date( town.departure.time *1000);
                        var departure = myDate.toLocaleTimeString( [], {hour: '2-digit', minute:'2-digit'});


                        if ( radius( lati ,longi, town.departure.place.loc[0] , town.departure.place.loc[1] ) < 9999999999999999979950 ){

                          console.log("radius = ",radius );
                            ridesAvailable = ridesAvailable+1;

                            fare= sharedCost(town.price);
                            console.log ("these are the trips", town );

                           var item = $( "<tr id=trip_row"+town._id+">  <td> <label> Destination: </label> "+town.destination.place.name + " - (" +  town.destination.place.town.name+" ) <br> <label> Seat(s): </label>" + town.seats + "<br> <label> Pickup: </label> " +town.departure.place.name + "<br> <label> Leaving @: </label> "+ departure +" <br> </td>"+ "<td>" + 


                                
                                "<span class='btn btn-info sharedTrip ' data-id="+ town._id+"> " +

                                " <small> Join</small>  " +

                                " </span> "+

                                 "<span class='btn btn-danger cancelTrip ' style='display:none' data-id="+ town._id+"> " +

                                " <small> Cancel </small>  " +

                                " </span> "+


                                "</td>"+

                                "</tr>" );

                           item.find('.sharedTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'join button' ,$(this).data('id') );

                                joinTrip( $(this).data('id') );

                                  }    );

                               item.find('.cancelTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'cancel' ,$(this).data('id') );

                                cancelTrip( $(this).data('id') );

                                }  );
                                    

                          $('#loading').append(item);

                        } // end of if radius bracket

                    // }// filtering undefined loc
                    } //end of trip type 'dropping'

                } 

                if ( ridesAvailable < 1){

                  $('#sorryMessage').empty();

                  $('#sorryMessage').append( " <div class='page-alert alert alert-warning' > " + 
                    " <button class='close' data-dismiss='alert'> " + " x " +"</button>" +
                    "<br> <b>Sorry</b>, there are no shared rides in your vicinity. \n You can reload page in a bit for update. " +

                      "</div>"



                    );

                }
    

        });

  }

	
  //dtermine radius distance.
    function radius (lat1,lon1,lat2,lon2){

//console.log("lat1=" , lat2);

       var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      d = d / 0.001; // Distance in Meters
      console.log("radius=" , d);

      return d;
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}



    

		function sharedCost(amount){

			return Math.floor ( amount - (0.33333 * amount) );

   		 }


   	//JoinAride

  function joinTrip( tripId ){

    console.log("in Join Trip", tripId);

        var joinObject ={  passengers:{}   }; 

            joinObject.passengers[user._id]='joined';

            var driverNum;
            var msg ="A new passenger has joined your ride :)";
            
            /**************retrieve driver's number *********************/
             $.get("https://makewegohq.herokuapp.com/api/trips?condition={_id:"+tripId+"}", {access_token:token} , function(data){

                driverNum = data.driver.phoneNumber;

                driverNum = driverNum.substr(1);



             });

             /*****************************/


          $.ajax({
               type: "POST",
               url: 'https://makewegohq.herokuapp.com/api/trips/'+tripId+'?access_token=' + token,
               async: false,
               data: JSON.stringify(joinObject) ,
               contentType: "application/json",
               complete: function (data) {
              //  console.log(data.responseJSON);
              
              wait = false;
                
               },

               success:function(data){
                //called when successful
                console.log('afer join successful ',data);

                //insert SMS launch; send sms to Driver
                sendSms(driverNum,msg);

  

                $('#loading').empty();

                buttons( 0 );

                 $('#trip_row'+data._id).addClass('joined'); 

                  $('#trip_row'+data._id).find('.sharedTrip').hide();

                  $('#trip_row'+data._id).find('.cancelTrip').show();
                 
                
               }

          }); 


          if (isDriver == 1 ) {

             var driverObject={ driver:user._id }  ;
           

             $.ajax({
                 type: "POST",
                 url: 'https://makewegohq.herokuapp.com/api/trips/'+tripId+'?access_token=' + token,
                 async: false,
                 data: JSON.stringify(driverObject) ,
                 contentType: "application/json",
                 complete: function (data) {
                //  console.log(data.responseJSON);
                
                wait = false;
                  
                 },

                 success:function(data){
                  //called when successful
                  console.log("successfully assigned a driver.");
                 }

               });  
           }   
          

  }


  //hide all buttons
  function buttons( num ){

    $('#loading').empty();

   

   // if (num ==0){
         for (var index in sharedTripData){

              var town = sharedTripData[index];


               var myDate = new Date( town.departure.time *1000);
        
             var depart = myDate.toLocaleTimeString( [], {hour: '2-digit', minute:'2-digit'} );

            if (town.trip_type!="Dropping" && town.departure.place !==null){


                            if ( radius( lati ,longi, town.departure.place.loc[0] , town.departure.place.loc[1] ) < 979950 ){

                              //console.log("radius = ",radius );

                              if (num ==0){
                               var item = $( "<tr id=trip_row"+town._id+">  <td> <label> Destination: </label> "+town.destination.place.name + " - (" +  town.destination.place.town.name+" ) <br> <label> Seat(s): </label>" + town.seats + "<br> <label> Pickup: </label> " +town.departure.place.name + "<br> <label> Leaving @: </label> "+ depart + "<br>" +"</td>"+ "<td>" +

                                  
                                    "<span class='btn btn-info sharedTrip ' style='display:none' data-id="+ town._id+"> " +

                                    " <small> Join</small>  " +

                                    " </span> "+

                                     "<span class='btn btn-danger cancelTrip ' style='display:none' data-id="+ town._id+"> " +

                                    " <small> Cancel </small>  " +

                                    " </span> "+
                                

                                    "</td>"+

                                    "</tr>" );
                         
                                }



                                else if (num ==1){

                                  var item = $( "<tr id=trip_row"+town._id+">  <td> <label> Destination: </label> "+town.destination.place.name + " - (" +  town.destination.place.town.name+" ) <br> <label> Seat(s): </label>" + town.seats + "<br> <label> Pickup: </label> " +town.departure.place.name + "<br> <label> Leaving @: </label> "+ depart+"<br> </td>"+ "<td>" +

                                    
                                    "<span class='btn btn-info sharedTrip ' data-id="+ town._id+"> " +

                                    " <small> Join</small>  " +

                                    " </span> "+

                                     "<span class='btn btn-danger cancelTrip ' style='display:none' data-id="+ town._id+"> " +

                                    " <small> Cancel </small>  " +

                                    " </span> "+


                                    "</td>"+

                                    "</tr>" );




                                }

                               item.find('.sharedTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'join button' ,$(this).data('id') );

                                joinTrip( $(this).data('id') );

                                  }    );

                               item.find('.cancelTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'cancel' ,$(this).data('id') );

                                cancelTrip( $(this).data('id') );

                                }  );
                             
                              $('#loading').append(item);

                           } // end of if radius bracket


            }

        }
     // }  
/*
      else if (num ==1){

        for (var index in sharedTripData){

              var town = sharedTripData[index];

            if (town.trip_type!="Dropping" && town.departure.place !==null){


                            if ( radius( lati ,longi, town.departure.place.loc[0] , town.departure.place.loc[1] ) < 979950 ){

                              //console.log("radius = ",radius );

                               var item = $( "<tr id=trip_row"+town._id+">  <td> <label> Destination: </label> "+town.destination.place.name + " - (" +  town.destination.place.town.name+" ) <br> <label> Seat(s): </label>" + town.seats + "<br> <label> Pickup: </label> " +town.departure.place.name + "<br> <label> Leaving @: </label> "+ depart"<br> </td>"+ "<td>" +

                                    
                                    "<span class='btn btn-info sharedTrip ' data-id="+ town._id+"> " +

                                    " <small> Join</small>  " +

                                    " </span> "+

                                     "<span class='btn btn-danger cancelTrip ' style='display:none' data-id="+ town._id+"> " +

                                    " <small> Cancel </small>  " +

                                    " </span> "+


                                    "</td>"+

                                    "</tr>" );

                               item.find('.sharedTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'join button' ,$(this).data('id') );

                                joinTrip( $(this).data('id') );

                                  }    );

                               item.find('.cancelTrip'). click( function(){

                             // alert('you just hd to click that'); 
                              console.log( 'cancel' ,$(this).data('id') );

                                cancelTrip( $(this).data('id') );

                                }  );

                             
                              $('#loading').append(item);

                           } // end of if radius bracket


            }

        }




      } */

  }



  //Cancel a joined trip


  function cancelTrip( tripId ){

    console.log("in Join Trip", tripId);

        var cancelObject ={  passengers:{}   }; 

            cancelObject.passengers[user._id]='cancel';

          $.ajax({
               type: "POST",
               url: 'https://makewegohq.herokuapp.com/api/trips/'+tripId+'?access_token=' + token,
               async: false,
               data: JSON.stringify(cancelObject) ,
               contentType: "application/json",
               complete: function (data) {
              //  console.log(data.responseJSON);
              
              wait = false;
                
               },

               success:function(data){
                //called when successful
                console.log('afer join successful ',data);

                 $('#trip_row'+data._id).removeClass('joined'); 

                 buttons(1);

                 // $('#trip_row'+data._id).find('.cancelTrip').hide();
                  //$('#trip_row'+data._id).find('.sharedTrip').show();

                  
                 
                
               }

          }); 

  }


function sendSms(num,msg){

  console.log("in sendSMS");


    $.get("https://api.smsgh.com/v3/messages/send?From=Mo'Go&To=%2B233"+num+"&Content="+msg+"&ClientId=nqdbsthu&ClientSecret=tfcopnlq&RegisteredDelivery=true", function(data){

      

    });

    


}

	 


});
 </script>

</body>

</html>